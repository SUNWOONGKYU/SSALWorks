# ê²°ì œ ì‹œìŠ¤í…œ ì„¤ì • ê°€ì´ë“œ

> í† ìŠ¤ í˜ì´ë¨¼íŠ¸ ì—°ë™ ì„¤ì •

**ì‘ì„±ì¼**: 2025-12-17
**ë²„ì „**: 1.0
**ìƒíƒœ**: ğŸ“ ë³¸ê°œë°œ ë‹¨ê³„ì—ì„œ ìƒì„¸ ì‘ì„± ì˜ˆì •

---

## ëª©ì°¨

1. [ê°œìš”](#1-ê°œìš”)
2. [ì „ì²´ êµ¬ì¡°ë„](#2-ì „ì²´-êµ¬ì¡°ë„)
3. [Phase 1: ê°€ë§¹ì  ë“±ë¡](#3-phase-1-ê°€ë§¹ì -ë“±ë¡)
4. [Phase 2: API í‚¤ ë°œê¸‰](#4-phase-2-api-í‚¤-ë°œê¸‰)
5. [Phase 3: í™˜ê²½ë³€ìˆ˜ ì„¤ì •](#5-phase-3-í™˜ê²½ë³€ìˆ˜-ì„¤ì •)
6. [Phase 4: ë¹Œë§í‚¤ ë°œê¸‰ (ì •ê¸°ê²°ì œ)](#6-phase-4-ë¹Œë§í‚¤-ë°œê¸‰-ì •ê¸°ê²°ì œ)
7. [Phase 5: ì›¹í›… ì„¤ì •](#7-phase-5-ì›¹í›…-ì„¤ì •)
8. [Phase 6: PG ì´ìš©ì•½ê´€ ë™ì˜ UI](#8-phase-6-pg-ì´ìš©ì•½ê´€-ë™ì˜-ui)
9. [ì²´í¬ë¦¬ìŠ¤íŠ¸](#9-ì²´í¬ë¦¬ìŠ¤íŠ¸)

---

## 1. ê°œìš”

### ëª©í‘œ
- í† ìŠ¤ í˜ì´ë¨¼íŠ¸ë¡œ êµ¬ë… ê²°ì œ ì‹œìŠ¤í…œ êµ¬í˜„
- ë¹Œë§í‚¤ ë°œê¸‰ ë° ì •ê¸°ê²°ì œ ìë™í™”
- ê²°ì œ ì›¹í›…ìœ¼ë¡œ ìƒíƒœ ê´€ë¦¬

### ê´€ë ¨ ì„œë¹„ìŠ¤
| ì„œë¹„ìŠ¤ | ì—­í•  |
|--------|------|
| **í† ìŠ¤ í˜ì´ë¨¼íŠ¸** | PGì‚¬, ê²°ì œ ì²˜ë¦¬ |
| **Supabase** | êµ¬ë… ìƒíƒœ ì €ì¥ |
| **Vercel** | ì›¹í›… ì—”ë“œí¬ì¸íŠ¸ |

### âš ï¸ ì‚¬ì „ ì¤€ë¹„ (ì¤‘ìš”!)

í† ìŠ¤ í˜ì´ë¨¼íŠ¸ ì—°ë™ ì „ í•„ìˆ˜ í™•ì¸:
- **ê°€ë§¹ì  ì‹¬ì‚¬**: 1-2ì£¼ ì†Œìš”
- **ì‚¬ì—…ìë“±ë¡ì¦** í•„ìš”
- **ì„œë¹„ìŠ¤ URL** í™•ì • í•„ìš”

---

## 2. ì „ì²´ êµ¬ì¡°ë„

```
ì‚¬ìš©ì
    â†“ êµ¬ë… ê²°ì œ ìš”ì²­
SSALWorks ì•±
    â†“ ì¹´ë“œ ì •ë³´ ì…ë ¥ (í† ìŠ¤ SDK)
í† ìŠ¤ í˜ì´ë¨¼íŠ¸
    â†“ ë¹Œë§í‚¤ ë°œê¸‰
SSALWorks API
    â†“ ë¹Œë§í‚¤ ì €ì¥
Supabase (user_payment_methods)
    â†“ ì •ê¸°ê²°ì œ ì‹¤í–‰
í† ìŠ¤ í˜ì´ë¨¼íŠ¸
    â†“ ê²°ì œ ê²°ê³¼ ì›¹í›…
SSALWorks API (/api/webhook/toss)
    â†“ êµ¬ë… ìƒíƒœ ì—…ë°ì´íŠ¸
Supabase (users.subscription_status)
```

---

## 3. Phase 1: ê°€ë§¹ì  ë“±ë¡

### 3.1 í† ìŠ¤ í˜ì´ë¨¼íŠ¸ ê°œë°œìì„¼í„° ê°€ì…
```
https://developers.tosspayments.com/
â†’ íšŒì›ê°€ì…
â†’ ê°œë°œìì„¼í„° ë¡œê·¸ì¸
```

### 3.2 ê°€ë§¹ì  ì‹ ì²­

**í•„ìš” ì„œë¥˜**:
- ì‚¬ì—…ìë“±ë¡ì¦
- ëŒ€í‘œì ì‹ ë¶„ì¦
- í†µì¥ ì‚¬ë³¸
- ì„œë¹„ìŠ¤ URL

**ì‹¬ì‚¬ ê¸°ê°„**: ì•½ 1-2ì£¼

### 3.3 í…ŒìŠ¤íŠ¸ ëª¨ë“œ

ì‹¬ì‚¬ ì™„ë£Œ ì „ì—ë„ **í…ŒìŠ¤íŠ¸ API í‚¤**ë¡œ ê°œë°œ ê°€ëŠ¥:
```
í…ŒìŠ¤íŠ¸ í´ë¼ì´ì–¸íŠ¸ í‚¤: test_ck_xxx
í…ŒìŠ¤íŠ¸ ì‹œí¬ë¦¿ í‚¤: test_sk_xxx
```

---

## 4. Phase 2: API í‚¤ ë°œê¸‰

### 4.1 API í‚¤ í™•ì¸

```
í† ìŠ¤ í˜ì´ë¨¼íŠ¸ ê°œë°œìì„¼í„° â†’ ë‚´ ê°œë°œì •ë³´ â†’ API í‚¤

í…ŒìŠ¤íŠ¸ í‚¤:
- í´ë¼ì´ì–¸íŠ¸ í‚¤: test_ck_xxxxxxxxxxxxxxxx
- ì‹œí¬ë¦¿ í‚¤: test_sk_xxxxxxxxxxxxxxxx

ë¼ì´ë¸Œ í‚¤ (ì‹¬ì‚¬ ì™„ë£Œ í›„):
- í´ë¼ì´ì–¸íŠ¸ í‚¤: live_ck_xxxxxxxxxxxxxxxx
- ì‹œí¬ë¦¿ í‚¤: live_sk_xxxxxxxxxxxxxxxx
```

### 4.2 í‚¤ ìš©ë„

| í‚¤ ì¢…ë¥˜ | ìš©ë„ | ë…¸ì¶œ ê°€ëŠ¥ |
|---------|------|----------|
| í´ë¼ì´ì–¸íŠ¸ í‚¤ | í”„ë¡ íŠ¸ì—”ë“œ SDK | âœ… ê°€ëŠ¥ |
| ì‹œí¬ë¦¿ í‚¤ | ì„œë²„ API í˜¸ì¶œ | âŒ ì ˆëŒ€ ê¸ˆì§€ |

---

## 5. Phase 3: í™˜ê²½ë³€ìˆ˜ ì„¤ì •

### 5.1 ë¡œì»¬ ê°œë°œ (.env.local)

```bash
# í† ìŠ¤ í˜ì´ë¨¼íŠ¸ (í…ŒìŠ¤íŠ¸)
TOSS_CLIENT_KEY=test_ck_xxxxxxxxxxxxxxxx
TOSS_SECRET_KEY=test_sk_xxxxxxxxxxxxxxxx

# í† ìŠ¤ í˜ì´ë¨¼íŠ¸ (í”„ë¡œë•ì…˜) - ì‹¬ì‚¬ ì™„ë£Œ í›„
# TOSS_CLIENT_KEY=live_ck_xxxxxxxxxxxxxxxx
# TOSS_SECRET_KEY=live_sk_xxxxxxxxxxxxxxxx
```

### 5.2 Vercel í™˜ê²½ë³€ìˆ˜

```
Vercel Dashboard â†’ Settings â†’ Environment Variables

| Key | Value | Environment |
|-----|-------|-------------|
| TOSS_CLIENT_KEY | test_ck_xxx... | Preview, Development |
| TOSS_SECRET_KEY | test_sk_xxx... | Preview, Development |
| TOSS_CLIENT_KEY | live_ck_xxx... | Production |
| TOSS_SECRET_KEY | live_sk_xxx... | Production |
```

---

## 6. Phase 4: ë¹Œë§í‚¤ ë°œê¸‰ (ì •ê¸°ê²°ì œ)

### 6.1 í† ìŠ¤ SDK ë¡œë“œ

```html
<script src="https://js.tosspayments.com/v1/payment"></script>
```

### 6.2 ë¹Œë§í‚¤ ë°œê¸‰ ìš”ì²­

```javascript
const tossPayments = TossPayments('test_ck_xxxxxxxxxxxxxxxx');

// ë¹Œë§í‚¤ ë°œê¸‰ (ì¹´ë“œ ë“±ë¡)
async function requestBillingKey() {
  await tossPayments.requestBillingAuth('ì¹´ë“œ', {
    customerKey: 'user_uuid_here',  // ì‚¬ìš©ì ê³ ìœ  ID
    successUrl: 'https://www.ssalworks.ai.kr/api/payment/billing/success',
    failUrl: 'https://www.ssalworks.ai.kr/api/payment/billing/fail',
  });
}
```

### 6.3 ë¹Œë§í‚¤ ì €ì¥ (ì„œë²„)

```javascript
// /api/payment/billing/success
export async function GET(request) {
  const { authKey, customerKey } = request.query;

  // í† ìŠ¤ APIë¡œ ë¹Œë§í‚¤ ë°œê¸‰ í™•ì •
  const response = await fetch('https://api.tosspayments.com/v1/billing/authorizations/issue', {
    method: 'POST',
    headers: {
      'Authorization': `Basic ${Buffer.from(TOSS_SECRET_KEY + ':').toString('base64')}`,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      authKey,
      customerKey,
    }),
  });

  const { billingKey, card } = await response.json();

  // Supabaseì— ë¹Œë§í‚¤ ì €ì¥
  await supabase.from('user_payment_methods').insert({
    user_id: customerKey,
    billing_key: billingKey,
    card_company: card.company,
    card_number_masked: card.number,  // ë§ˆìŠ¤í‚¹ëœ ì¹´ë“œë²ˆí˜¸
  });
}
```

### 6.4 ì •ê¸°ê²°ì œ ì‹¤í–‰

```javascript
// ë§¤ì›” ì •ê¸°ê²°ì œ ì‹¤í–‰ (Cron Job ë˜ëŠ” Vercel Cron)
async function executeSubscriptionPayment(userId, billingKey, amount) {
  const response = await fetch('https://api.tosspayments.com/v1/billing/' + billingKey, {
    method: 'POST',
    headers: {
      'Authorization': `Basic ${Buffer.from(TOSS_SECRET_KEY + ':').toString('base64')}`,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      customerKey: userId,
      amount: amount,
      orderId: `order_${Date.now()}`,
      orderName: 'SSALWorks ì›” êµ¬ë…',
    }),
  });

  return response.json();
}
```

---

## 7. Phase 5: ì›¹í›… ì„¤ì •

### 7.1 ì›¹í›… URL ë“±ë¡

```
í† ìŠ¤ í˜ì´ë¨¼íŠ¸ ê°œë°œìì„¼í„° â†’ ì›¹í›… ì„¤ì •

ì›¹í›… URL: https://www.ssalworks.ai.kr/api/webhook/toss
```

### 7.2 ì›¹í›… ì—”ë“œí¬ì¸íŠ¸ êµ¬í˜„

```javascript
// /api/webhook/toss
export async function POST(request) {
  const payload = await request.json();

  // ì›¹í›… ì‹œê·¸ë‹ˆì²˜ ê²€ì¦ (ë³´ì•ˆ)
  const signature = request.headers.get('Toss-Signature');
  // ... ì‹œê·¸ë‹ˆì²˜ ê²€ì¦ ë¡œì§

  switch (payload.eventType) {
    case 'PAYMENT_STATUS_CHANGED':
      if (payload.status === 'DONE') {
        // ê²°ì œ ì„±ê³µ â†’ êµ¬ë… ìƒíƒœ ì—…ë°ì´íŠ¸
        await supabase.from('users').update({
          subscription_status: 'active',
          subscription_start_date: new Date(),
        }).eq('user_id', payload.customerKey);
      }
      break;

    case 'BILLING_KEY_DELETED':
      // ë¹Œë§í‚¤ ì‚­ì œ â†’ ê²°ì œ ìˆ˜ë‹¨ ì‚­ì œ
      await supabase.from('user_payment_methods')
        .delete()
        .eq('billing_key', payload.billingKey);
      break;
  }

  return new Response('OK');
}
```

---

## 8. Phase 6: PG ì´ìš©ì•½ê´€ ë™ì˜ UI

### âš ï¸ ë²•ì  í•„ìˆ˜ ìš”ì†Œ!

ê²°ì œ ì§„í–‰ ì „ ë‹¤ìŒ ì•½ê´€ ë™ì˜ í•„ìˆ˜:

### 8.1 í•„ìˆ˜ ì•½ê´€

| ì•½ê´€ | ë²•ì  ê·¼ê±° |
|------|----------|
| ì „ìê¸ˆìœµê±°ë˜ ì´ìš©ì•½ê´€ | ì „ìê¸ˆìœµê±°ë˜ë²• |
| ê°œì¸ì •ë³´ ì œ3ì ì œê³µ ë™ì˜ | ê°œì¸ì •ë³´ë³´í˜¸ë²• |
| ê²°ì œëŒ€í–‰ ì„œë¹„ìŠ¤ ì´ìš©ì•½ê´€ | PGì‚¬ ìš”êµ¬ |

### 8.2 UI êµ¬í˜„ ì˜ˆì‹œ

```html
<div class="payment-terms">
  <h3>ê²°ì œ ì•½ê´€ ë™ì˜</h3>

  <label>
    <input type="checkbox" id="terms-all" onchange="toggleAllTerms(this)">
    <strong>ì „ì²´ ë™ì˜</strong>
  </label>

  <label>
    <input type="checkbox" class="term-checkbox" required>
    [í•„ìˆ˜] ì „ìê¸ˆìœµê±°ë˜ ì´ìš©ì•½ê´€
    <a href="#" onclick="showTermsPopup('efin')">ë³´ê¸°</a>
  </label>

  <label>
    <input type="checkbox" class="term-checkbox" required>
    [í•„ìˆ˜] ê°œì¸ì •ë³´ ì œ3ì ì œê³µ ë™ì˜ (í† ìŠ¤í˜ì´ë¨¼íŠ¸)
    <a href="#" onclick="showTermsPopup('privacy')">ë³´ê¸°</a>
  </label>

  <label>
    <input type="checkbox" class="term-checkbox" required>
    [í•„ìˆ˜] ê²°ì œëŒ€í–‰ ì„œë¹„ìŠ¤ ì´ìš©ì•½ê´€
    <a href="#" onclick="showTermsPopup('pg')">ë³´ê¸°</a>
  </label>
</div>

<button onclick="proceedPayment()" id="pay-button" disabled>
  ê²°ì œí•˜ê¸°
</button>
```

### 8.3 ë™ì˜ ì—¬ë¶€ DB ì €ì¥

```javascript
// ê²°ì œ ì§„í–‰ ì „ ë™ì˜ ì—¬ë¶€ ì €ì¥
await supabase.from('payment_consents').insert({
  user_id: userId,
  efin_terms_agreed: true,
  privacy_third_party_agreed: true,
  pg_terms_agreed: true,
  agreed_at: new Date(),
});
```

---

## 9. ì²´í¬ë¦¬ìŠ¤íŠ¸

### Phase 1: ê°€ë§¹ì  ë“±ë¡
- [ ] í† ìŠ¤ í˜ì´ë¨¼íŠ¸ ê°œë°œìì„¼í„° ê°€ì…
- [ ] ê°€ë§¹ì  ì‹¬ì‚¬ ì‹ ì²­ (1-2ì£¼ ì†Œìš”)
- [ ] í…ŒìŠ¤íŠ¸ API í‚¤ë¡œ ê°œë°œ ì‹œì‘

### Phase 2: API í‚¤
- [ ] í…ŒìŠ¤íŠ¸ í´ë¼ì´ì–¸íŠ¸ í‚¤ í™•ì¸
- [ ] í…ŒìŠ¤íŠ¸ ì‹œí¬ë¦¿ í‚¤ í™•ì¸
- [ ] (ì‹¬ì‚¬ ì™„ë£Œ í›„) ë¼ì´ë¸Œ í‚¤ í™•ì¸

### Phase 3: í™˜ê²½ë³€ìˆ˜
- [ ] ë¡œì»¬ .env.local ì„¤ì •
- [ ] Vercel í™˜ê²½ë³€ìˆ˜ ì„¤ì • (í…ŒìŠ¤íŠ¸/í”„ë¡œë•ì…˜ ë¶„ë¦¬)

### Phase 4: ë¹Œë§í‚¤ ë°œê¸‰
- [ ] í† ìŠ¤ SDK ì—°ë™
- [ ] ë¹Œë§í‚¤ ë°œê¸‰ API êµ¬í˜„
- [ ] ë¹Œë§í‚¤ ì €ì¥ í…Œì´ë¸” (user_payment_methods)

### Phase 5: ì›¹í›…
- [ ] ì›¹í›… URL ë“±ë¡
- [ ] ì›¹í›… ì—”ë“œí¬ì¸íŠ¸ êµ¬í˜„
- [ ] ê²°ì œ ìƒíƒœ ì—…ë°ì´íŠ¸ ë¡œì§

### Phase 6: ì•½ê´€ ë™ì˜
- [ ] ì „ìê¸ˆìœµê±°ë˜ ì´ìš©ì•½ê´€ ë™ì˜ UI
- [ ] ê°œì¸ì •ë³´ ì œ3ì ì œê³µ ë™ì˜ UI
- [ ] ë™ì˜ ì—¬ë¶€ DB ì €ì¥

### í…ŒìŠ¤íŠ¸
- [ ] í…ŒìŠ¤íŠ¸ ì¹´ë“œë¡œ ê²°ì œ í…ŒìŠ¤íŠ¸
- [ ] ì •ê¸°ê²°ì œ í…ŒìŠ¤íŠ¸
- [ ] ì›¹í›… ìˆ˜ì‹  í…ŒìŠ¤íŠ¸
- [ ] ê²°ì œ ì·¨ì†Œ/í™˜ë¶ˆ í…ŒìŠ¤íŠ¸

---

## ì°¸ê³  ë¬¸ì„œ

- [í† ìŠ¤ í˜ì´ë¨¼íŠ¸ ê°œë°œì ë¬¸ì„œ](https://docs.tosspayments.com/)
- [ë¹Œë§í‚¤ ë°œê¸‰ ê°€ì´ë“œ](https://docs.tosspayments.com/guides/billing)
- [ê²°ì œ ì›¹í›… ê°€ì´ë“œ](https://docs.tosspayments.com/guides/webhook)
- [í…ŒìŠ¤íŠ¸ ì¹´ë“œ ì •ë³´](https://docs.tosspayments.com/reference/test-card)

---

## âš ï¸ ë³¸ê°œë°œ ë‹¨ê³„ TODO

ì´ ë¬¸ì„œëŠ” ê¸°ë³¸ êµ¬ì¡°ë§Œ ì •ë¦¬ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
ë³¸ê°œë°œ ë‹¨ê³„ì—ì„œ ë‹¤ìŒ í•­ëª©ì„ ìƒì„¸ ì‘ì„±í•´ì•¼ í•©ë‹ˆë‹¤:

- [ ] ì‹¤ì œ ë¹Œë§í‚¤ ë°œê¸‰ í…ŒìŠ¤íŠ¸ ê²°ê³¼
- [ ] ì •ê¸°ê²°ì œ Cron Job ì„¤ì • ë°©ë²•
- [ ] ê²°ì œ ì‹¤íŒ¨ ì‹œ ì¬ì‹œë„ ë¡œì§
- [ ] í™˜ë¶ˆ ì²˜ë¦¬ í”Œë¡œìš°
- [ ] ì—ëŸ¬ í•¸ë“¤ë§ ìƒì„¸

---

**Last Updated**: 2025-12-17
