# 결제 시스템 설정 가이드

> 토스페이먼츠 연동

---

# Part A - 기초

> PO(Project Owner; 사람)가 직접 해야 할 설정

---

## Step 1: 토스페이먼츠 가입

1. https://developers.tosspayments.com 접속
2. 회원가입
3. 개발자센터 로그인

---

## Step 2: 가맹점 신청

1. 가맹점 심사 신청
2. 필요 서류:

| 서류 | 비고 |
|------|------|
| 사업자등록증 | 필수 |
| 대표자 신분증 | 필수 |
| 통장 사본 | 필수 |
| 서비스 URL | 필수 |

3. 심사 완료 대기 (1-2주 소요)

---

## Step 3: API 키 확인

1. 개발자센터 → **내 개발정보** → **API 키**
2. 아래 키 복사:

**테스트 키** (심사 전 개발용):

| 항목 | 형식 |
|------|------|
| 클라이언트 키 | test_ck_xxxxxxxxxxxxxxxx |
| 시크릿 키 | test_sk_xxxxxxxxxxxxxxxx |

**라이브 키** (심사 완료 후):

| 항목 | 형식 |
|------|------|
| 클라이언트 키 | live_ck_xxxxxxxxxxxxxxxx |
| 시크릿 키 | live_sk_xxxxxxxxxxxxxxxx |

---

## Step 4: 환경변수 설정

1. Vercel → **Settings** → **Environment Variables**
2. 아래 환경변수 추가:

| Key | Value | Environment |
|-----|-------|-------------|
| TOSS_CLIENT_KEY | test_ck_xxx... | Preview, Development |
| TOSS_SECRET_KEY | test_sk_xxx... | Preview, Development |
| TOSS_CLIENT_KEY | live_ck_xxx... | Production |
| TOSS_SECRET_KEY | live_sk_xxx... | Production |

---

## Step 5: 웹훅 URL 등록

1. 개발자센터 → **웹훅 설정**
2. 웹훅 URL 입력:
   ```
   https://www.ssalworks.ai.kr/api/webhook/toss
   ```

---

## 체크리스트

- [ ] 토스페이먼츠 개발자센터 가입 완료
- [ ] 가맹점 심사 신청 완료
- [ ] 테스트 API 키 확인 완료
- [ ] 환경변수 설정 완료
- [ ] 웹훅 URL 등록 완료
- [ ] (심사 완료 후) 라이브 키 확인 완료

---

# Part B - 심화

> Claude Code 참조용 기술 문서

**전제조건**: Part A 완료 (토스페이먼츠 가입, API 키 확보)

---

## 1. 전체 흐름

```
사용자
    ↓ 구독 결제 요청
SSALWorks 앱
    ↓ 카드 정보 입력 (토스 SDK)
토스페이먼츠
    ↓ 빌링키 발급
SSALWorks API
    ↓ 빌링키 저장
Supabase (user_payment_methods)
    ↓ 정기결제 실행
토스페이먼츠
    ↓ 결제 결과 웹훅
SSALWorks API (/api/webhook/toss)
    ↓ 구독 상태 업데이트
Supabase (users.subscription_status)
```

---

## 2. 토스 SDK 연동

### 2.1 SDK 로드

```html
<script src="https://js.tosspayments.com/v1/payment"></script>
```

### 2.2 빌링키 발급 요청

```javascript
const tossPayments = TossPayments('test_ck_xxxxxxxxxxxxxxxx');

async function requestBillingKey() {
  await tossPayments.requestBillingAuth('카드', {
    customerKey: 'user_uuid_here',
    successUrl: 'https://www.ssalworks.ai.kr/api/payment/billing/success',
    failUrl: 'https://www.ssalworks.ai.kr/api/payment/billing/fail',
  });
}
```

---

## 3. 빌링키 저장 (서버)

```javascript
// /api/payment/billing/success
export async function GET(request) {
  const { authKey, customerKey } = request.query;

  // 토스 API로 빌링키 발급 확정
  const response = await fetch('https://api.tosspayments.com/v1/billing/authorizations/issue', {
    method: 'POST',
    headers: {
      'Authorization': `Basic ${Buffer.from(TOSS_SECRET_KEY + ':').toString('base64')}`,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ authKey, customerKey }),
  });

  const { billingKey, card } = await response.json();

  // Supabase에 빌링키 저장
  await supabase.from('user_payment_methods').insert({
    user_id: customerKey,
    billing_key: billingKey,
    card_company: card.company,
    card_number_masked: card.number,
  });
}
```

---

## 4. 정기결제 실행

```javascript
async function executeSubscriptionPayment(userId, billingKey, amount) {
  const response = await fetch('https://api.tosspayments.com/v1/billing/' + billingKey, {
    method: 'POST',
    headers: {
      'Authorization': `Basic ${Buffer.from(TOSS_SECRET_KEY + ':').toString('base64')}`,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      customerKey: userId,
      amount: amount,
      orderId: `order_${Date.now()}`,
      orderName: 'SSALWorks 월 구독',
    }),
  });

  return response.json();
}
```

---

## 5. 웹훅 엔드포인트

```javascript
// /api/webhook/toss
export async function POST(request) {
  const payload = await request.json();

  switch (payload.eventType) {
    case 'PAYMENT_STATUS_CHANGED':
      if (payload.status === 'DONE') {
        await supabase.from('users').update({
          subscription_status: 'active',
          subscription_start_date: new Date(),
        }).eq('user_id', payload.customerKey);
      }
      break;

    case 'BILLING_KEY_DELETED':
      await supabase.from('user_payment_methods')
        .delete()
        .eq('billing_key', payload.billingKey);
      break;
  }

  return new Response('OK');
}
```

---

## 6. PG 약관 동의 UI (법적 필수)

```html
<div class="payment-terms">
  <label>
    <input type="checkbox" required>
    [필수] 전자금융거래 이용약관
  </label>

  <label>
    <input type="checkbox" required>
    [필수] 개인정보 제3자 제공 동의 (토스페이먼트)
  </label>

  <label>
    <input type="checkbox" required>
    [필수] 결제대행 서비스 이용약관
  </label>
</div>
```

---

## 7. 키 용도 구분

| 키 종류 | 용도 | 노출 가능 |
|---------|------|----------|
| 클라이언트 키 | 프론트엔드 SDK | ✅ |
| 시크릿 키 | 서버 API 호출 | ❌ |

---

## 참고 문서

- [토스페이먼츠 개발자 문서](https://docs.tosspayments.com/)
- [빌링키 발급 가이드](https://docs.tosspayments.com/guides/billing)
- [결제 웹훅 가이드](https://docs.tosspayments.com/guides/webhook)
- [테스트 카드 정보](https://docs.tosspayments.com/reference/test-card)
