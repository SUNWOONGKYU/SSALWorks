# ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì • ê°€ì´ë“œ

> Supabase Database + RLS ì •ì±… ì„¤ì •

**ì‘ì„±ì¼**: 2025-12-17
**ë²„ì „**: 1.0

---

## ëª©ì°¨

1. [ê°œìš”](#1-ê°œìš”)
2. [Supabase í”„ë¡œì íŠ¸ ìƒì„±](#2-supabase-í”„ë¡œì íŠ¸-ìƒì„±)
3. [API í‚¤ í™•ì¸](#3-api-í‚¤-í™•ì¸)
4. [Database í…Œì´ë¸” ìƒì„±](#4-database-í…Œì´ë¸”-ìƒì„±)
5. [RLS (Row Level Security) ì„¤ì •](#5-rls-row-level-security-ì„¤ì •)
6. [í™˜ê²½ë³€ìˆ˜ ì„¤ì •](#6-í™˜ê²½ë³€ìˆ˜-ì„¤ì •)
7. [íŠ¸ëŸ¬ë¸”ìŠˆíŒ…](#7-íŠ¸ëŸ¬ë¸”ìŠˆíŒ…)
8. [ì²´í¬ë¦¬ìŠ¤íŠ¸](#8-ì²´í¬ë¦¬ìŠ¤íŠ¸)

---

## 1. ê°œìš”

### ëª©í‘œ
- Supabase í”„ë¡œì íŠ¸ ìƒì„± ë° ì„¤ì •
- PostgreSQL ë°ì´í„°ë² ì´ìŠ¤ í…Œì´ë¸” êµ¬ì„±
- RLS ì •ì±…ìœ¼ë¡œ ë°ì´í„° ë³´ì•ˆ ì„¤ì •
- API í‚¤ ë° í™˜ê²½ë³€ìˆ˜ ê´€ë¦¬

### Supabaseë€?
- **PostgreSQL ê¸°ë°˜** ì˜¤í”ˆì†ŒìŠ¤ Backend-as-a-Service
- ë°ì´í„°ë² ì´ìŠ¤ + ì¸ì¦ + ìŠ¤í† ë¦¬ì§€ + ì‹¤ì‹œê°„ ê¸°ëŠ¥ ì œê³µ
- Firebaseì˜ ì˜¤í”ˆì†ŒìŠ¤ ëŒ€ì•ˆ

---

## 2. Supabase í”„ë¡œì íŠ¸ ìƒì„±

### 2.1 ê³„ì • ìƒì„±
1. https://supabase.com ì ‘ì†
2. "Start your project" í´ë¦­
3. GitHub ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸

### 2.2 ìƒˆ í”„ë¡œì íŠ¸ ìƒì„±
1. Dashboardì—ì„œ "New Project" í´ë¦­
2. Organization ì„ íƒ (ì—†ìœ¼ë©´ ìƒì„±)
3. í”„ë¡œì íŠ¸ ì •ë³´ ì…ë ¥:

| í•­ëª© | ì…ë ¥ê°’ | ì„¤ëª… |
|------|--------|------|
| **Name** | ssalworks | í”„ë¡œì íŠ¸ ì´ë¦„ |
| **Database Password** | (ê°•ë ¥í•œ ë¹„ë°€ë²ˆí˜¸) | **ë°˜ë“œì‹œ ì €ì¥í•´ë‘˜ ê²ƒ!** |
| **Region** | Northeast Asia (Seoul) | í•œêµ­ ì„œë²„ |

4. "Create new project" í´ë¦­
5. í”„ë¡œì íŠ¸ ìƒì„± ì™„ë£Œê¹Œì§€ ì•½ 2ë¶„ ëŒ€ê¸°

---

## 3. API í‚¤ í™•ì¸

### 3.1 API í‚¤ ì°¾ê¸°
```
Supabase Dashboard â†’ Project Settings (í†±ë‹ˆë°”í€´) â†’ API
```

### 3.2 í•„ìš”í•œ ê°’ë“¤

| í‚¤ | ìš©ë„ | ë…¸ì¶œ ê°€ëŠ¥ |
|----|------|----------|
| **Project URL** | `https://[í”„ë¡œì íŠ¸ID].supabase.co` | âœ… ê°€ëŠ¥ |
| **anon (public) key** | í´ë¼ì´ì–¸íŠ¸(ë¸Œë¼ìš°ì €)ì—ì„œ ì‚¬ìš© | âœ… ê°€ëŠ¥ |
| **service_role key** | ì„œë²„ì—ì„œë§Œ ì‚¬ìš© (RLS ìš°íšŒ) | âŒ **ì ˆëŒ€ ë…¸ì¶œ ê¸ˆì§€!** |

### 3.3 í‚¤ ì‚¬ìš© êµ¬ë¶„

```javascript
// í´ë¼ì´ì–¸íŠ¸ (ë¸Œë¼ìš°ì €) - anon key ì‚¬ìš©
const supabaseClient = supabase.createClient(
  'https://xxx.supabase.co',
  'eyJhbGci...' // anon key
);

// ì„œë²„ (API, Serverless) - service_role key ì‚¬ìš©
const supabaseAdmin = supabase.createClient(
  'https://xxx.supabase.co',
  'eyJhbGci...' // service_role key
);
```

**âš ï¸ ì£¼ì˜**: `service_role key`ëŠ” RLSë¥¼ ìš°íšŒí•˜ë¯€ë¡œ ì ˆëŒ€ í´ë¼ì´ì–¸íŠ¸ì— ë…¸ì¶œí•˜ë©´ ì•ˆ ë¨!

---

## 4. Database í…Œì´ë¸” ìƒì„±

### 4.1 Table Editor ì‚¬ìš©
```
Supabase Dashboard â†’ Table Editor â†’ Create a new table
```

### 4.2 SQL Editor ì‚¬ìš© (ê¶Œì¥)
```
Supabase Dashboard â†’ SQL Editor â†’ New query
```

### 4.3 ê¸°ë³¸ í…Œì´ë¸” ì˜ˆì‹œ

#### users í…Œì´ë¸”
```sql
CREATE TABLE users (
  user_id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  email TEXT UNIQUE NOT NULL,
  nickname TEXT,
  name TEXT,
  role TEXT DEFAULT 'user',
  is_active BOOLEAN DEFAULT true,
  subscription_status TEXT DEFAULT 'none',
  terms_agreed BOOLEAN DEFAULT false,
  privacy_agreed BOOLEAN DEFAULT false,
  marketing_agreed BOOLEAN DEFAULT false,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- RLS í™œì„±í™”
ALTER TABLE users ENABLE ROW LEVEL SECURITY;
```

#### notices í…Œì´ë¸” (ê³µì§€ì‚¬í•­)
```sql
CREATE TABLE notices (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  title TEXT NOT NULL,
  content TEXT,
  important BOOLEAN DEFAULT false,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

ALTER TABLE notices ENABLE ROW LEVEL SECURITY;
```

#### user_payment_methods í…Œì´ë¸” (ê²°ì œ ìˆ˜ë‹¨)
```sql
CREATE TABLE user_payment_methods (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES users(user_id) ON DELETE CASCADE,
  billing_key TEXT NOT NULL,
  card_company TEXT,
  card_number_masked TEXT,
  is_default BOOLEAN DEFAULT false,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

ALTER TABLE user_payment_methods ENABLE ROW LEVEL SECURITY;
```

### 4.4 í…Œì´ë¸” ìƒì„± í™•ì¸
```
Table Editorì—ì„œ ìƒì„±ëœ í…Œì´ë¸” í™•ì¸
ë˜ëŠ” SQL:
SELECT table_name FROM information_schema.tables
WHERE table_schema = 'public';
```

---

## 5. RLS (Row Level Security) ì„¤ì •

### 5.1 RLSë€?
- **Row Level Security**: í–‰ ë‹¨ìœ„ ë³´ì•ˆ ì •ì±…
- ëˆ„ê°€ ì–´ë–¤ ë°ì´í„°ë¥¼ ì½ê³ /ì“¸ ìˆ˜ ìˆëŠ”ì§€ ì œì–´
- Supabaseì˜ í•µì‹¬ ë³´ì•ˆ ê¸°ëŠ¥

### 5.2 RLS í™œì„±í™”
```sql
-- í…Œì´ë¸”ì— RLS í™œì„±í™”
ALTER TABLE [í…Œì´ë¸”ëª…] ENABLE ROW LEVEL SECURITY;
```

### 5.3 ì •ì±… ìƒì„± ë°©ë²•

```
Supabase Dashboard â†’ Authentication â†’ Policies
ë˜ëŠ”
Table Editor â†’ í…Œì´ë¸” ì„ íƒ â†’ RLS íƒ­
```

### 5.4 ê¸°ë³¸ ì •ì±… ì˜ˆì‹œ

#### users í…Œì´ë¸” ì •ì±…
```sql
-- ë³¸ì¸ ë°ì´í„°ë§Œ ì¡°íšŒ ê°€ëŠ¥
CREATE POLICY "Users can view own data"
ON users FOR SELECT
TO authenticated
USING (auth.uid() = user_id);

-- ë³¸ì¸ ë°ì´í„°ë§Œ ìˆ˜ì • ê°€ëŠ¥
CREATE POLICY "Users can update own data"
ON users FOR UPDATE
TO authenticated
USING (auth.uid() = user_id);

-- íšŒì›ê°€ì… ì‹œ í”„ë¡œí•„ ìƒì„± í—ˆìš©
CREATE POLICY "Users can insert own profile"
ON users FOR INSERT
TO authenticated
WITH CHECK (auth.uid() = user_id);
```

#### notices í…Œì´ë¸” ì •ì±… (ê³µê°œ ì½ê¸°)
```sql
-- ëª¨ë“  ì‚¬ìš©ì ì½ê¸° í—ˆìš©
CREATE POLICY "Anyone can read notices"
ON notices FOR SELECT
TO public
USING (true);

-- ì¸ì¦ëœ ì‚¬ìš©ìë§Œ ì“°ê¸° (ê´€ë¦¬ì ì²´í¬ ì¶”ê°€ ê°€ëŠ¥)
CREATE POLICY "Authenticated users can insert"
ON notices FOR INSERT
TO authenticated
WITH CHECK (true);
```

### 5.5 ì •ì±… ì—­í•  (Roles)

| Role | ì„¤ëª… |
|------|------|
| `public` | ëª¨ë“  ì‚¬ìš©ì (ë¡œê·¸ì¸ ì•ˆ í•´ë„) |
| `anon` | ìµëª… ì‚¬ìš©ì (ë¡œê·¸ì¸ ì•ˆ í•œ ìƒíƒœ) |
| `authenticated` | ë¡œê·¸ì¸í•œ ì‚¬ìš©ì |

### 5.6 ì •ì±… ì‘ì—… ìœ í˜•

| ì‘ì—… | ì„¤ëª… |
|------|------|
| `SELECT` | ì¡°íšŒ |
| `INSERT` | ìƒì„± |
| `UPDATE` | ìˆ˜ì • |
| `DELETE` | ì‚­ì œ |
| `ALL` | ëª¨ë“  ì‘ì—… |

---

## 6. í™˜ê²½ë³€ìˆ˜ ì„¤ì •

### 6.1 ë¡œì»¬ ê°œë°œ (.env.local)

```bash
# Supabase
SUPABASE_URL=https://[í”„ë¡œì íŠ¸ID].supabase.co
SUPABASE_ANON_KEY=eyJhbGci...
SUPABASE_SERVICE_ROLE_KEY=eyJhbGci...
```

### 6.2 Vercel í™˜ê²½ë³€ìˆ˜

```
Vercel Dashboard â†’ Project â†’ Settings â†’ Environment Variables

| Key | Value | Environment |
|-----|-------|-------------|
| SUPABASE_URL | https://xxx.supabase.co | All |
| SUPABASE_ANON_KEY | eyJxxx... | All |
| SUPABASE_SERVICE_ROLE_KEY | eyJxxx... | All |
```

### 6.3 í´ë¼ì´ì–¸íŠ¸ ì½”ë“œì—ì„œ ì‚¬ìš©

```javascript
// ë¸Œë¼ìš°ì €ì—ì„œ ì§ì ‘ ì‚¬ìš© (anon keyë§Œ!)
const SUPABASE_URL = 'https://[í”„ë¡œì íŠ¸ID].supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGci...';

const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// ë°ì´í„° ì¡°íšŒ
const { data, error } = await supabaseClient
  .from('notices')
  .select('*')
  .order('created_at', { ascending: false });
```

---

## 7. íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

### ğŸ”´ ë¬¸ì œ 1: RLS ì •ì±… ì˜¤ë¥˜ - ë¹ˆ ê²°ê³¼

**ì¦ìƒ**: ë°ì´í„°ê°€ ìˆëŠ”ë° ì¡°íšŒ ì‹œ ë¹ˆ ë°°ì—´ ë°˜í™˜

**ì›ì¸**: RLSê°€ í™œì„±í™”ëëŠ”ë° ì •ì±…ì´ ì—†ìŒ

**í•´ê²°**:
1. RLS ì •ì±… í™•ì¸
   ```sql
   SELECT * FROM pg_policies WHERE tablename = 'í…Œì´ë¸”ëª…';
   ```
2. ì ì ˆí•œ ì •ì±… ì¶”ê°€
3. ë˜ëŠ” ê°œë°œ ì¤‘ ì„ì‹œë¡œ RLS ë¹„í™œì„±í™”:
   ```sql
   ALTER TABLE [í…Œì´ë¸”ëª…] DISABLE ROW LEVEL SECURITY;
   ```
   âš ï¸ **í”„ë¡œë•ì…˜ì—ì„œëŠ” ì ˆëŒ€ ë¹„í™œì„±í™”í•˜ì§€ ë§ ê²ƒ!**

---

### ğŸ”´ ë¬¸ì œ 2: ê¶Œí•œ ì˜¤ë¥˜ (403/401)

**ì¦ìƒ**: "permission denied for table" ë˜ëŠ” 401 ì—ëŸ¬

**ì›ì¸**:
- anon keyë¡œ service_roleì´ í•„ìš”í•œ ì‘ì—… ì‹œë„
- RLS ì •ì±…ì´ í•´ë‹¹ ì‘ì—…ì„ í—ˆìš©í•˜ì§€ ì•ŠìŒ

**í•´ê²°**:
1. ì„œë²„ì—ì„œëŠ” `service_role key` ì‚¬ìš©
2. í´ë¼ì´ì–¸íŠ¸ì—ì„œëŠ” ì ì ˆí•œ RLS ì •ì±… ì¶”ê°€
3. ì •ì±…ì—ì„œ ì—­í• (role) í™•ì¸

---

### ğŸ”´ ë¬¸ì œ 3: API í‚¤ ì˜¤ë¥˜

**ì¦ìƒ**: "Invalid API key" ë˜ëŠ” 401 ì—ëŸ¬

**í•´ê²°**:
1. API í‚¤ ë³µì‚¬ ì‹œ ê³µë°± í™•ì¸
2. í™˜ê²½ë³€ìˆ˜ ë¡œë“œ í™•ì¸
3. anon key vs service_role key êµ¬ë¶„ í™•ì¸

---

### ğŸ”´ ë¬¸ì œ 4: Foreign Key ì˜¤ë¥˜

**ì¦ìƒ**: "violates foreign key constraint"

**ì›ì¸**: ì°¸ì¡°í•˜ëŠ” ë°ì´í„°ê°€ ì—†ìŒ

**í•´ê²°**:
1. ì°¸ì¡° í…Œì´ë¸”ì— ë°ì´í„° ë¨¼ì € ìƒì„±
2. ë˜ëŠ” `ON DELETE CASCADE` ì˜µì…˜ í™•ì¸
3. users í…Œì´ë¸”ì˜ ê²½ìš° `auth.users`ì™€ ë™ê¸°í™” í™•ì¸

---

### ğŸ”´ ë¬¸ì œ 5: auth.usersì™€ users í…Œì´ë¸” ë¶ˆì¼ì¹˜

**ì¦ìƒ**: ë¡œê·¸ì¸ì€ ë˜ëŠ”ë° í”„ë¡œí•„ ì¡°íšŒ ì‹¤íŒ¨

**ì›ì¸**: `auth.users`ì—ëŠ” ìˆëŠ”ë° `public.users`ì—ëŠ” ì—†ìŒ

**í•´ê²°**: 02_ì´ë©”ì¼_ì‹œìŠ¤í…œ_ì„¤ì •.mdì˜ "auth.users â†” users í…Œì´ë¸” ë™ê¸°í™”" ì°¸ì¡°

---

## 8. ì²´í¬ë¦¬ìŠ¤íŠ¸

### í”„ë¡œì íŠ¸ ìƒì„±
- [ ] Supabase ê³„ì • ìƒì„±
- [ ] í”„ë¡œì íŠ¸ ìƒì„± (Seoul ë¦¬ì „)
- [ ] Database Password ì €ì¥

### API í‚¤
- [ ] Project URL í™•ì¸
- [ ] anon key í™•ì¸
- [ ] service_role key í™•ì¸ (ë¹„ë°€ ë³´ê´€)

### í…Œì´ë¸”
- [ ] users í…Œì´ë¸” ìƒì„±
- [ ] í•„ìš”í•œ í…Œì´ë¸”ë“¤ ìƒì„±
- [ ] Foreign Key ê´€ê³„ ì„¤ì •

### RLS ì •ì±…
- [ ] ê° í…Œì´ë¸” RLS í™œì„±í™”
- [ ] SELECT ì •ì±… ìƒì„±
- [ ] INSERT/UPDATE/DELETE ì •ì±… ìƒì„±
- [ ] ì •ì±… í…ŒìŠ¤íŠ¸

### í™˜ê²½ë³€ìˆ˜
- [ ] .env.local ì„¤ì • (ë¡œì»¬)
- [ ] Vercel í™˜ê²½ë³€ìˆ˜ ì„¤ì • (ë°°í¬)

### í…ŒìŠ¤íŠ¸
- [ ] ë°ì´í„° ì¡°íšŒ í…ŒìŠ¤íŠ¸
- [ ] ë°ì´í„° ìƒì„± í…ŒìŠ¤íŠ¸
- [ ] RLS ì •ì±… ë™ì‘ í™•ì¸
- [ ] ê¶Œí•œ ì—†ëŠ” ì ‘ê·¼ ì°¨ë‹¨ í™•ì¸

---

## âš ï¸ ë³´ì•ˆ ì£¼ì˜ì‚¬í•­

### ì ˆëŒ€ í•˜ë©´ ì•ˆ ë˜ëŠ” ê²ƒ
- âŒ `service_role key`ë¥¼ í´ë¼ì´ì–¸íŠ¸ì— ë…¸ì¶œ
- âŒ í”„ë¡œë•ì…˜ì—ì„œ RLS ë¹„í™œì„±í™”
- âŒ `public` ì—­í• ì— INSERT/UPDATE/DELETE í—ˆìš© (íŠ¹ë³„í•œ ê²½ìš° ì œì™¸)

### ê¶Œì¥ ì‚¬í•­
- âœ… ìµœì†Œ ê¶Œí•œ ì›ì¹™ ì ìš©
- âœ… ë¯¼ê°í•œ í…Œì´ë¸”ì€ `authenticated` ì—­í• ë§Œ í—ˆìš©
- âœ… ì •ê¸°ì ìœ¼ë¡œ RLS ì •ì±… ê²€í† 

---

## ì°¸ê³  ë¬¸ì„œ

- [Supabase ê³µì‹ ë¬¸ì„œ](https://supabase.com/docs)
- [Supabase JavaScript í´ë¼ì´ì–¸íŠ¸](https://supabase.com/docs/reference/javascript)
- [RLS ê°€ì´ë“œ](https://supabase.com/docs/guides/auth/row-level-security)
- [PostgreSQL ì •ì±… ë¬¸ë²•](https://www.postgresql.org/docs/current/sql-createpolicy.html)

---

**Last Updated**: 2025-12-17
