# 01. 회원인증 설정 가이드

> Google OAuth + Supabase Auth 통합 설정

**작성일**: 2025-12-17
**버전**: 1.0

---

## 목차

1. [개요](#1-개요)
2. [전체 구조도](#2-전체-구조도)
3. [Supabase 프로젝트 생성](#3-supabase-프로젝트-생성)
4. [Google Cloud Console 설정](#4-google-cloud-console-설정)
5. [Supabase Auth Provider 설정](#5-supabase-auth-provider-설정)
6. [클라이언트 구현](#6-클라이언트-구현)
7. [트러블슈팅](#7-트러블슈팅)
8. [체크리스트](#8-체크리스트)

---

## 1. 개요

### 목표
- Google OAuth를 통한 소셜 로그인 구현
- Supabase Auth로 사용자 인증 관리

### 관련 서비스
| 서비스 | 역할 |
|--------|------|
| **Google Cloud Console** | OAuth 2.0 클라이언트 발급 |
| **Supabase** | Auth Provider, 사용자 DB 관리 |

---

## 2. 전체 구조도

```
사용자 (브라우저)
    ↓ Google 로그인 버튼 클릭
SSALWorks 앱
    ↓ signInWithOAuth('google')
Supabase Auth
    ↓ OAuth 요청
Google OAuth (Google Cloud Console)
    ↓ 인증 완료
Supabase Callback URL
    ↓ 세션 생성
SSALWorks 앱 (로그인 완료)
```

---

## 3. Supabase 프로젝트 생성

### 3.1 계정 생성
1. https://supabase.com 접속
2. "Start your project" 클릭
3. GitHub 계정으로 로그인

### 3.2 새 프로젝트 생성
1. Dashboard에서 "New Project" 클릭
2. Organization 선택 (없으면 생성)
3. 프로젝트 정보 입력:
   - **Name**: 프로젝트 이름 (예: ssalworks)
   - **Database Password**: 강력한 비밀번호 설정 (저장해둘 것!)
   - **Region**: Northeast Asia (Seoul) 선택
4. "Create new project" 클릭
5. 프로젝트 생성 완료까지 약 2분 대기

### 3.3 API 키 확인
1. Supabase Dashboard → **Project Settings** (톱니바퀴)
2. **API** 탭 클릭
3. 필요한 값 복사:

```
Project URL: https://[프로젝트ID].supabase.co
anon (public) key: eyJhbGci... (클라이언트용)
service_role key: eyJhbGci... (서버 전용, 절대 노출 금지!)
```

---

## 4. Google Cloud Console 설정

### 4.1 프로젝트 생성
1. https://console.cloud.google.com 접속
2. 프로젝트 선택 → "새 프로젝트" 클릭
3. 프로젝트 이름 입력 (예: ssalworks)
4. "만들기" 클릭

### 4.2 OAuth 동의 화면 구성
```
APIs & Services → OAuth consent screen

- User Type: External (외부)
- App name: SSAL Works (사용자에게 표시될 이름)
- User support email: 본인 이메일
- Scopes: email, profile, openid
- Test users: 테스트할 이메일 추가 (개발 중일 때)
```

### 4.3 OAuth 2.0 클라이언트 생성

**⚠️ 중요**: Application type은 반드시 **"Web application"** 선택!
("Desktop" 선택 시 Redirect URI 설정 불가)

```
APIs & Services → Credentials → Create Credentials → OAuth client ID

- Application type: Web application ← 반드시!
- Name: SSALWorks Web
- Authorized redirect URIs:
  https://[프로젝트ID].supabase.co/auth/v1/callback
```

### 4.4 발급된 정보 저장
```
Client ID: [복사해서 저장]
Client Secret: [복사해서 저장]
```

---

## 5. Supabase Auth Provider 설정

### 5.1 Google Provider 활성화
```
Supabase Dashboard → Authentication → Providers → Google

- Enable Google provider: ON
- Client ID: [Google에서 발급받은 Client ID]
- Client Secret: [Google에서 발급받은 Client Secret]
```

### 5.2 Callback URL 확인
```
Callback URL (read-only):
https://[프로젝트ID].supabase.co/auth/v1/callback
```

이 URL을 Google Cloud Console의 "Authorized redirect URIs"에 등록해야 함

### 5.3 Redirect URLs 설정
```
Supabase Dashboard → Authentication → URL Configuration

Site URL: https://yourdomain.com (프로덕션 URL)

Redirect URLs (허용할 콜백 URL):
  - http://localhost:3000/**
  - http://localhost:8888/**
  - https://yourdomain.com/**
  - https://*.vercel.app/**
```

---

## 6. 클라이언트 구현

### 6.1 Supabase Client 초기화

```html
<!-- Supabase JS CDN -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
const SUPABASE_URL = 'https://[프로젝트ID].supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGci...';

const { createClient } = supabase;
const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
</script>
```

### 6.2 Google 로그인 함수

```javascript
async function handleGoogleLogin() {
    const { data, error } = await supabaseClient.auth.signInWithOAuth({
        provider: 'google',
        options: {
            redirectTo: window.location.origin + '/index.html',
            queryParams: {
                access_type: 'offline',
                prompt: 'consent'
            }
        }
    });

    if (error) {
        console.error('로그인 오류:', error.message);
        alert('로그인 실패: ' + error.message);
        return;
    }
}
```

### 6.3 세션 확인

```javascript
async function checkSession() {
    const { data: { session } } = await supabaseClient.auth.getSession();

    if (session) {
        console.log('로그인됨:', session.user.email);
        return session.user;
    } else {
        console.log('로그인 안됨');
        return null;
    }
}

// 페이지 로드 시 세션 확인
window.addEventListener('load', checkSession);
```

### 6.4 로그아웃

```javascript
async function handleLogout() {
    const { error } = await supabaseClient.auth.signOut();

    if (!error) {
        window.location.href = '/pages/auth/login.html';
    }
}
```

### 6.5 인증 상태 변경 감지

```javascript
supabaseClient.auth.onAuthStateChange((event, session) => {
    if (event === 'SIGNED_IN') {
        console.log('로그인됨:', session.user);
    } else if (event === 'SIGNED_OUT') {
        console.log('로그아웃됨');
    }
});
```

---

## 7. 트러블슈팅

### 7.1 "Unsupported provider: provider is not enabled"

**원인**: Supabase에서 Google Provider가 활성화되지 않음

**해결**:
1. Supabase Dashboard → Authentication → Providers
2. Google 클릭
3. Enable 토글 ON
4. Client ID, Client Secret 입력

---

### 7.2 "redirect_uri_mismatch" 오류

**원인**: Google Console의 Redirect URI와 실제 요청 URI 불일치

**해결**:
1. Google Cloud Console → Credentials → OAuth 2.0 Client
2. Authorized redirect URIs에 정확한 URL 추가:
   ```
   https://[프로젝트ID].supabase.co/auth/v1/callback
   ```
3. 오타 확인 (특히 `/auth/v1/callback` 부분)

---

### 7.3 OAuth Client Type 오류

**증상**: Redirect URI 설정란이 안 보임

**원인**: OAuth client type을 "Desktop"으로 생성함

**해결**:
1. 기존 클라이언트 삭제
2. 새로 생성 시 **"Web application"** 선택

---

### 7.4 "페이지를 찾을 수 없음" (로컬 테스트)

**원인**: `file://` 프로토콜로 HTML 파일 직접 열기

**해결**:
```bash
# 로컬 서버 실행
cd Production/Frontend
npx serve . -l 8888

# 브라우저에서 접속
http://localhost:8888/pages/auth/google-login.html
```

---

### 7.5 로그인 후 원래 페이지로 안 돌아옴

**원인**: `redirectTo` 설정 누락 또는 Supabase Redirect URLs 미등록

**해결**:
1. 코드에서 `redirectTo` 확인:
   ```javascript
   options: {
       redirectTo: window.location.origin + '/index.html'
   }
   ```
2. Supabase Dashboard → Authentication → URL Configuration
3. Redirect URLs에 해당 URL 패턴 추가

---

## 8. 체크리스트

### Google Cloud Console
- [ ] 프로젝트 생성
- [ ] OAuth 동의 화면 구성
- [ ] OAuth 2.0 클라이언트 생성 (**Web application** 타입!)
- [ ] Client ID, Client Secret 복사

### Supabase
- [ ] 프로젝트 생성
- [ ] API 키 확인 (URL, anon key)
- [ ] Google Provider 활성화
- [ ] Client ID, Client Secret 입력
- [ ] Redirect URLs 설정

### 클라이언트
- [ ] Supabase JS 로드
- [ ] createClient 초기화
- [ ] signInWithOAuth 구현
- [ ] 로컬 서버에서 테스트 (`file://` 사용 금지)
- [ ] 로그인 → 리다이렉트 → 세션 확인 성공

---

## 관련 파일

| 파일 | 용도 |
|------|------|
| `Production/Frontend/pages/auth/google-login.html` | Google 로그인 UI |
| `Production/Frontend/assets/js/auth.js` | 인증 관련 함수 |

---

## 참고 문서

- [Supabase Auth Documentation](https://supabase.com/docs/guides/auth)
- [Google OAuth Setup (Supabase)](https://supabase.com/docs/guides/auth/social-login/auth-google)
- [Google Cloud Console](https://console.cloud.google.com)

---

**Last Updated**: 2025-12-17
