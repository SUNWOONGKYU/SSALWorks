# íšŒì›ê°€ì…ì„ ìœ„í•œ ì´ë©”ì¼ ì¸ì¦ ì‹œìŠ¤í…œ êµ¬ì¶• ë°©ë²•

**ì‘ì„±ì¼**: 2025-11-20
**ì‘ì„±ì**: Claude Code
**ë‚œì´ë„**: â­â­â­â­ (ìƒê¸‰)
**ì†Œìš”ì‹œê°„**: ì•½ 10ì‹œê°„ (ì‹œí–‰ì°©ì˜¤ í¬í•¨)

## ğŸ“‹ ëª©ì°¨

1. [ê°œìš”](#ê°œìš”)
2. [ê´€ë ¨ ì„œë¹„ìŠ¤ ë° ì—­í• ](#ê´€ë ¨-ì„œë¹„ìŠ¤-ë°-ì—­í• )
3. [ì „ì²´ êµ¬ì¡°ë„](#ì „ì²´-êµ¬ì¡°ë„)
4. [ë‹¨ê³„ë³„ êµ¬ì¶• ê³¼ì •](#ë‹¨ê³„ë³„-êµ¬ì¶•-ê³¼ì •)
5. [ë°œìƒí•œ ë¬¸ì œì™€ í•´ê²° ë°©ë²•](#ë°œìƒí•œ-ë¬¸ì œì™€-í•´ê²°-ë°©ë²•)
6. [í•µì‹¬ êµí›ˆ](#í•µì‹¬-êµí›ˆ)
7. [ì²´í¬ë¦¬ìŠ¤íŠ¸](#ì²´í¬ë¦¬ìŠ¤íŠ¸)

---

## ê°œìš”

Next.js ì•±ì—ì„œ Supabase Authë¥¼ ì‚¬ìš©í•œ ì´ë©”ì¼ ì¸ì¦ ì‹œìŠ¤í…œì„ êµ¬ì¶•í•˜ë©´ì„œ ê²ªì€ ì‹¤ì „ ê²½í—˜ì„ ì •ë¦¬í•œ ê°€ì´ë“œì…ë‹ˆë‹¤.

### ëª©í‘œ
- ì‚¬ìš©ìê°€ íšŒì›ê°€ì…í•˜ë©´ ì¸ì¦ ì´ë©”ì¼ ë°œì†¡
- ì´ë©”ì¼ ë§í¬ í´ë¦­ ì‹œ ìë™ ë¡œê·¸ì¸
- í”„ë¡œë•ì…˜ í™˜ê²½ì—ì„œ ì•ˆì •ì ì¸ ë™ì‘

### ìµœì¢… ê²°ê³¼
- âœ… íšŒì›ê°€ì… â†’ ì´ë©”ì¼ ë°œì†¡ â†’ ì¸ì¦ â†’ ë¡œê·¸ì¸ ì „ì²´ í”„ë¡œì„¸ìŠ¤ ì •ìƒ ì‘ë™
- âœ… DKIM ì¸ì¦ìœ¼ë¡œ ìŠ¤íŒ¸ ë°©ì§€
- âœ… auth.usersì™€ users í…Œì´ë¸” ì™„ì „ ë™ê¸°í™”

---

## ê´€ë ¨ ì„œë¹„ìŠ¤ ë° ì—­í• 

ì´ ì‹œìŠ¤í…œì„ êµ¬ì¶•í•˜ë ¤ë©´ **4ê°œì˜ ì„œë¹„ìŠ¤**ê°€ í•„ìš”í•©ë‹ˆë‹¤:

### 1. Vercel (ë°°í¬ í”Œë«í¼)
**ì—­í• **: Next.js ì•± í˜¸ìŠ¤íŒ… ë° ë°°í¬
- í”„ë¡œë•ì…˜ URL ì œê³µ (`https://www.politicianfinder.ai.kr`)
- í™˜ê²½ë³€ìˆ˜ ê´€ë¦¬
- ìë™ ë°°í¬ (GitHub ì—°ë™)

### 2. Supabase (ë°±ì—”ë“œ/ì¸ì¦)
**ì—­í• **: ì‚¬ìš©ì ì¸ì¦ ë° ë°ì´í„°ë² ì´ìŠ¤
- Auth ì‹œìŠ¤í…œ (íšŒì›ê°€ì…, ë¡œê·¸ì¸, ì´ë©”ì¼ ì¸ì¦)
- PostgreSQL ë°ì´í„°ë² ì´ìŠ¤
- ì´ë©”ì¼ í…œí”Œë¦¿ ê´€ë¦¬
- SMTP ì„¤ì •

### 3. Resend (ì´ë©”ì¼ ë°œì†¡)
**ì—­í• **: ì‹¤ì œ ì´ë©”ì¼ ì „ì†¡
- SMTP ì„œë²„ ì œê³µ
- DKIM ì¸ì¦ ê´€ë¦¬
- ë°œì†¡ í†µê³„ ë° ë¡œê·¸

### 4. Whois (ë„ë©”ì¸ ë“±ë¡ì—…ì²´)
**ì—­í• **: ë„ë©”ì¸ DNS ê´€ë¦¬
- DKIM TXT ë ˆì½”ë“œ ë“±ë¡
- ë„ë©”ì¸ ì†Œìœ ê¶Œ ì¸ì¦
- DNS ì„¤ì • ê´€ë¦¬

---

## ì „ì²´ êµ¬ì¡°ë„

```
ì‚¬ìš©ì (ë¸Œë¼ìš°ì €)
    â†“ íšŒì›ê°€ì…
Next.js App (Vercel)
    â†“ API ìš”ì²­
Supabase Auth
    â†“ SMTP ìš”ì²­
Resend (SMTP)
    â†“ DKIM ê²€ì¦ (DNS)
Whois (ë„ë©”ì¸ DNS)
    â†“ ì´ë©”ì¼ ë°œì†¡
ì‚¬ìš©ì ì´ë©”ì¼
    â†“ ë§í¬ í´ë¦­
Next.js App (/auth/callback)
    â†“ ì„¸ì…˜ ìƒì„±
ë¡œê·¸ì¸ ì™„ë£Œ
```

---

## ë‹¨ê³„ë³„ êµ¬ì¶• ê³¼ì •

### Phase 1: Resend SMTP ì„¤ì •

#### 1-1. Resend ê³„ì • ìƒì„± ë° ë„ë©”ì¸ ë“±ë¡
```bash
# Resend ê°€ì…
https://resend.com

# ë„ë©”ì¸ ë“±ë¡
- Domain: politicianfinder.ai.kr
- ìƒíƒœ: Pending (DKIM ì¸ì¦ ëŒ€ê¸°)
```

#### 1-2. DKIM TXT ë ˆì½”ë“œ ë“±ë¡ (Whois)
Resendì—ì„œ ì œê³µí•˜ëŠ” DKIM ì •ë³´ë¥¼ ë„ë©”ì¸ DNSì— ë“±ë¡:

```
ë ˆì½”ë“œ íƒ€ì…: TXT
í˜¸ìŠ¤íŠ¸ëª…: resend._domainkey
ê°’: p=MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQC... (Resend ì œê³µ)
TTL: 3600
```

**ì¤‘ìš”**: DNS ì „íŒŒëŠ” ìµœëŒ€ 48ì‹œê°„ ì†Œìš” (ë³´í†µ 1-2ì‹œê°„)

#### 1-3. DKIM ì¸ì¦ í™•ì¸
```bash
# Resend Dashboardì—ì„œ í™•ì¸
Domain Status: âœ… Verified
```

### Phase 2: Supabase SMTP ì—°ë™

#### 2-1. Supabaseì— Resend SMTP ì„¤ì •
```
Supabase Dashboard â†’ Settings â†’ Auth â†’ SMTP Settings

SMTP Host: smtp.resend.com
SMTP Port: 587
SMTP Username: resend
SMTP Password: [Resend API Key]
Sender Email: noreply@politicianfinder.ai.kr
Sender Name: PoliticianFinder
```

#### 2-2. Site URL ì„¤ì •
```
Settings â†’ Auth â†’ URL Configuration

Site URL: https://www.politicianfinder.ai.kr
Redirect URLs:
  - http://localhost:3000/auth/callback
  - https://www.politicianfinder.ai.kr/auth/callback
```

### Phase 3: Next.js íšŒì›ê°€ì… API êµ¬í˜„

#### 3-1. íšŒì›ê°€ì… API ì‘ì„±
```typescript
// app/api/auth/signup/route.ts
import { createAdminClient } from '@/lib/supabase/admin';

export async function POST(request: NextRequest) {
  const { email, password, nickname } = await request.json();

  // 1. Supabase Authì— ì‚¬ìš©ì ìƒì„±
  const { data: authData, error: authError } = await supabase.auth.signUp({
    email,
    password,
    options: {
      data: { name: nickname },
      emailRedirectTo: 'https://www.politicianfinder.ai.kr/auth/callback',
    },
  });

  if (authError) {
    // ì—ëŸ¬ ì²˜ë¦¬
  }

  // 2. users í…Œì´ë¸”ì— í”„ë¡œí•„ ìƒì„± (ì¤‘ìš”!)
  const adminClient = createAdminClient();
  const { error: profileError } = await adminClient
    .from('users')
    .insert({
      user_id: authData.user.id,  // âš ï¸ ì»¬ëŸ¼ëª… ì£¼ì˜! (idê°€ ì•„ë‹ˆë¼ user_id)
      email,
      nickname,
      name: nickname,
      role: 'user',
      is_active: true,
      terms_agreed: true,
      privacy_agreed: true,
      marketing_agreed: false,
    });

  // 3. users í…Œì´ë¸” ì‚½ì… ì‹¤íŒ¨ ì‹œ ë¡¤ë°± (ì¤‘ìš”!)
  if (profileError) {
    await adminClient.auth.admin.deleteUser(authData.user.id);
    return NextResponse.json({ error: 'íšŒì›ê°€ì… ì‹¤íŒ¨' }, { status: 500 });
  }

  return NextResponse.json({ success: true });
}
```

**í•µì‹¬ í¬ì¸íŠ¸:**
- âœ… `emailRedirectTo`ë¡œ ì¸ì¦ í›„ ë¦¬ë‹¤ì´ë ‰íŠ¸ URL ì§€ì •
- âœ… users í…Œì´ë¸” ì‚½ì… ì‹¤íŒ¨ ì‹œ **ë°˜ë“œì‹œ ë¡¤ë°±** (ë°ì´í„° ì¼ê´€ì„±)
- âœ… ì»¬ëŸ¼ëª… í™•ì¸ (`user_id` vs `id`)

#### 3-2. ì¸ì¦ ì½œë°± ì²˜ë¦¬
```typescript
// app/auth/callback/route.ts
import { createRouteHandlerClient } from '@supabase/auth-helpers-nextjs';
import { cookies } from 'next/headers';
import { NextRequest, NextResponse } from 'next/server';

export async function GET(request: NextRequest) {
  const requestUrl = new URL(request.url);
  const code = requestUrl.searchParams.get('code');

  if (code) {
    const supabase = createRouteHandlerClient({ cookies });
    await supabase.auth.exchangeCodeForSession(code);
  }

  return NextResponse.redirect(
    new URL('/auth/login?verified=true', request.url)
  );
}
```

### Phase 4: ì´ë©”ì¼ í…œí”Œë¦¿ ìˆ˜ì • âš ï¸ **ê°€ì¥ ì¤‘ìš”!**

#### 4-1. ë¬¸ì œ: ì˜ëª»ëœ ë„ë©”ì¸ ë§í¬
ê¸°ë³¸ Supabase í…œí”Œë¦¿ì€ `{{ .SiteURL }}` ë³€ìˆ˜ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤:

```html
<!-- ê¸°ë³¸ í…œí”Œë¦¿ (ë¬¸ì œ ìˆìŒ) -->
<a href="{{ .SiteURL }}/auth/callback?...">ì´ë©”ì¼ ì¸ì¦í•˜ê¸°</a>

<!-- ì‹¤ì œ ìƒì„±ë˜ëŠ” URL -->
https://politicianfinder.ai.kr/auth/callback?...
```

**ë¬¸ì œì :**
- `{{ .SiteURL }}`ì€ Supabase Dashboardì˜ Site URL ì„¤ì •ê°’ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©
- `emailRedirectTo` íŒŒë¼ë¯¸í„°ë¥¼ **ë¬´ì‹œí•¨**
- www ì„œë¸Œë„ë©”ì¸ì´ ë¹ ì§ â†’ DNS ì—ëŸ¬

#### 4-2. í•´ê²°: URL í•˜ë“œì½”ë”©

```
Supabase Dashboard â†’ Authentication â†’ Email Templates â†’ Confirm signup
```

**ë³€ê²½ ì „:**
```html
<a href="{{ .SiteURL }}/auth/confirm?token_hash={{ .TokenHash }}&type=signup">
  ì´ë©”ì¼ ì¸ì¦í•˜ê¸°
</a>
```

**ë³€ê²½ í›„:**
```html
<a href="https://www.politicianfinder.ai.kr/auth/callback?token_hash={{ .TokenHash }}&type=signup">
  ì´ë©”ì¼ ì¸ì¦í•˜ê¸°
</a>
```

**í•µì‹¬:**
- âœ… ë„ë©”ì¸ì„ **ì§ì ‘ í•˜ë“œì½”ë”©** (ê°€ì¥ í™•ì‹¤í•¨)
- âœ… `{{ .TokenHash }}` ë³€ìˆ˜ë§Œ ìœ ì§€
- âœ… ë‹¤ë¥¸ í…œí”Œë¦¿ë„ ë™ì¼í•˜ê²Œ ìˆ˜ì • (Magic Link, Password Reset ë“±)

#### 4-3. Send Email Hookì€ ì‚¬ìš© ì•ˆ í•¨!

ì‹œë„í–ˆìœ¼ë‚˜ ì‹¤íŒ¨í•œ ë°©ë²•:
- âŒ Send Email Hook (webhook ì¸ì¦ ë¬¸ì œ, ë³µì¡ë„ ì¦ê°€)
- âŒ Edge Functionìœ¼ë¡œ ì´ë©”ì¼ ë°œì†¡ (ë””ë²„ê¹… ì–´ë ¤ì›€)

**ìµœì¢… ì„ íƒ:**
- âœ… SMTP (Resend) + í…œí”Œë¦¿ ìˆ˜ì • = ê°€ì¥ ê°„ë‹¨í•˜ê³  ì•ˆì •ì 

### Phase 5: ë¡œê·¸ì¸ API ìˆ˜ì •

#### 5-1. users í…Œì´ë¸” ì¡°íšŒ ë° ìë™ ìƒì„±
```typescript
// app/api/auth/login/route.ts
export async function POST(request: NextRequest) {
  const { email, password } = await request.json();

  // 1. Supabase Auth ë¡œê·¸ì¸
  const { data: authData, error } = await supabase.auth.signInWithPassword({
    email,
    password,
  });

  // 2. users í…Œì´ë¸”ì—ì„œ í”„ë¡œí•„ ì¡°íšŒ
  const { data: userProfile } = await supabase
    .from('users')
    .select('*')
    .eq('user_id', authData.user.id)  // âš ï¸ user_idë¡œ ì¡°íšŒ!
    .single();

  // 3. í”„ë¡œí•„ ì—†ìœ¼ë©´ ìë™ ìƒì„± (ì´ì¤‘ ì•ˆì „ì¥ì¹˜)
  if (!userProfile) {
    await supabase.from('users').insert({
      user_id: authData.user.id,
      email: authData.user.email,
      nickname: authData.user.email.split('@')[0],
      // ... ë‚˜ë¨¸ì§€ í•„ë“œ
    });
  }

  return NextResponse.json({ success: true, user: authData.user });
}
```

**í•µì‹¬:**
- âœ… auth.usersì™€ users í…Œì´ë¸” **ì´ì¤‘ ì•ˆì „ì¥ì¹˜**
- âœ… íšŒì›ê°€ì… ì‹œ users í…Œì´ë¸” ì‚½ì… ì‹¤íŒ¨í•´ë„ ë¡œê·¸ì¸ ì‹œ ìë™ ìƒì„±

---

## ë°œìƒí•œ ë¬¸ì œì™€ í•´ê²° ë°©ë²•

### ğŸ”´ ë¬¸ì œ 1: ì´ë©”ì¼ ë§í¬ê°€ ì˜ëª»ëœ ë„ë©”ì¸ìœ¼ë¡œ ìƒì„±

**ì¦ìƒ:**
```
ì´ë©”ì¼ ë§í¬: https://politicianfinder.ai.kr/auth/callback?...
ì—ëŸ¬: DNS_PROBE_FINISHED_NXDOMAIN
```

**ì›ì¸:**
- Supabase ì´ë©”ì¼ í…œí”Œë¦¿ì´ `{{ .SiteURL }}` ë³€ìˆ˜ ì‚¬ìš©
- ì´ ë³€ìˆ˜ëŠ” `emailRedirectTo` íŒŒë¼ë¯¸í„°ë¥¼ ë¬´ì‹œí•˜ê³  Site URL ì„¤ì •ê°’ë§Œ ì‚¬ìš©

**ì‹œë„í•œ í•´ê²°ì±… (ëª¨ë‘ ì‹¤íŒ¨):**
1. âŒ `NEXT_PUBLIC_SITE_URL` í™˜ê²½ë³€ìˆ˜ ë³€ê²½ â†’ í…œí”Œë¦¿ì— ì˜í–¥ ì—†ìŒ
2. âŒ Supabase Site URL ì„¤ì • ë³€ê²½ â†’ ë³€ìˆ˜ê°€ ê·¸ëŒ€ë¡œ ì‚¬ìš©ë¨
3. âŒ `emailRedirectTo` í•˜ë“œì½”ë”© â†’ `{{ .SiteURL }}`ì´ ìš°ì„ 
4. âŒ Send Email Hook êµ¬í˜„ â†’ "Hook requires authorization token" ì—ëŸ¬
5. âŒ Hook webhook ê²€ì¦ ì œê±° â†’ ì´ë©”ì¼ ë°œì†¡ ì•ˆë¨

**ìµœì¢… í•´ê²°:**
```html
<!-- í…œí”Œë¦¿ì—ì„œ ì§ì ‘ í•˜ë“œì½”ë”© -->
<a href="https://www.politicianfinder.ai.kr/auth/callback?token_hash={{ .TokenHash }}&type=signup">
```

**ì†Œìš” ì‹œê°„**: ì•½ 6ì‹œê°„

---

### ğŸ”´ ë¬¸ì œ 2: ì´ë©”ì¼ ì¸ì¦ í›„ ë¡œê·¸ì¸ ì‹¤íŒ¨

**ì¦ìƒ:**
```
- ì´ë©”ì¼ ì¸ì¦ ì™„ë£Œ (auth.usersì— email_confirmed_at ìˆìŒ)
- ì˜¬ë°”ë¥¸ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥
- ë¡œê·¸ì¸ ì‹¤íŒ¨: "ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤"
```

**ì›ì¸:**
```sql
-- auth.usersì—ëŠ” ì¡´ì¬
SELECT * FROM auth.users WHERE email = 'test@test.com';
-- âœ… 1 row

-- users í…Œì´ë¸”ì—ëŠ” ì—†ìŒ!
SELECT * FROM users WHERE email = 'test@test.com';
-- âŒ 0 rows
```

**ê·¼ë³¸ ì›ì¸:**
íšŒì›ê°€ì… APIì—ì„œ ì˜ëª»ëœ ì»¬ëŸ¼ëª… ì‚¬ìš©:
```typescript
// âŒ ì˜ëª»ëœ ì½”ë“œ
.insert({
  id: authData.user.id,  // 'id' ì»¬ëŸ¼ì´ ì—†ìŒ!
  email,
  // ...
})

// âœ… ì˜¬ë°”ë¥¸ ì½”ë“œ
.insert({
  user_id: authData.user.id,  // 'user_id'ê°€ ì˜¬ë°”ë¥¸ ì»¬ëŸ¼ëª…
  email,
  // ...
})
```

**í•´ê²° ë°©ë²•:**
1. íšŒì›ê°€ì… API: `id` â†’ `user_id` ìˆ˜ì •
2. ë¡œê·¸ì¸ API: `user_id`ë¡œ ì¡°íšŒí•˜ë„ë¡ ìˆ˜ì •
3. í”„ë¡œí•„ ì—†ìœ¼ë©´ ìë™ ìƒì„± (ì´ì¤‘ ì•ˆì „ì¥ì¹˜)
4. users í…Œì´ë¸” ì‚½ì… ì‹¤íŒ¨ ì‹œ auth.users ì‚­ì œ (ë¡¤ë°±)

**ì†Œìš” ì‹œê°„**: ì•½ 2ì‹œê°„

---

### ğŸ”´ ë¬¸ì œ 3: DKIM ì¸ì¦ ì—†ì–´ì„œ ìŠ¤íŒ¸ ì²˜ë¦¬

**ì¦ìƒ:**
- ì´ë©”ì¼ì´ ìŠ¤íŒ¸ í´ë”ë¡œ ì´ë™
- Gmailì—ì„œ "ë°œì‹ ì ì¸ì¦ ì•ˆë¨" ê²½ê³ 

**í•´ê²°:**
1. Resendì—ì„œ DKIM TXT ë ˆì½”ë“œ ì •ë³´ ë³µì‚¬
2. Whois DNS ê´€ë¦¬ í˜ì´ì§€ì—ì„œ TXT ë ˆì½”ë“œ ì¶”ê°€
3. 1-2ì‹œê°„ ëŒ€ê¸° (DNS ì „íŒŒ)
4. Resendì—ì„œ "Verify" í´ë¦­

**ì†Œìš” ì‹œê°„**: ì•½ 30ë¶„ (DNS ì „íŒŒ ëŒ€ê¸° ì œì™¸)

---

## í•µì‹¬ êµí›ˆ

### 1. Supabase ì´ë©”ì¼ í…œí”Œë¦¿ ë³€ìˆ˜ì˜ í•¨ì •

**í…œí”Œë¦¿ ë³€ìˆ˜ ë¹„êµ:**

| ë³€ìˆ˜ | ë™ì‘ | emailRedirectTo ë°˜ì˜ |
|------|------|---------------------|
| `{{ .SiteURL }}` | Dashboard Site URL ê·¸ëŒ€ë¡œ ì‚¬ìš© | âŒ ë¬´ì‹œí•¨ |
| `{{ .ConfirmationURL }}` | Supabaseê°€ ìë™ ìƒì„± (í† í° í¬í•¨) | âœ… ë°˜ì˜ë¨ |
| `{{ .RedirectTo }}` | emailRedirectTo íŒŒë¼ë¯¸í„° ê°’ | âœ… ë°˜ì˜ë¨ |
| í•˜ë“œì½”ë”© | ì§ì ‘ ì…ë ¥í•œ URL | N/A (ë³€ìˆ˜ ì•„ë‹˜) |

**Best Practice:**
- ë„ë©”ì¸ì´ í™•ì •ë˜ë©´ **í•˜ë“œì½”ë”©**ì´ ê°€ì¥ ì•ˆì „
- `{{ .TokenHash }}`ë§Œ ë³€ìˆ˜ë¡œ ìœ ì§€

### 2. Send Email Hookì€ í•„ìš” ì—†ë‹¤

**Hookì„ ì‚¬ìš©í•´ì•¼ í•˜ëŠ” ê²½ìš°:**
- âœ… ì¡°ê±´ë¶€ ì´ë©”ì¼ ë°œì†¡ (íŠ¹ì • ì‚¬ìš©ìë§Œ)
- âœ… ë‹¤ë¥¸ ì´ë©”ì¼ ì„œë¹„ìŠ¤ API ì‚¬ìš© (SendGrid, Mailgun ë“±)
- âœ… ë³µì¡í•œ ì»¤ìŠ¤í…€ ë¡œì§ í•„ìš”

**Hookì´ ë¶ˆí•„ìš”í•œ ê²½ìš°:**
- âŒ ë‹¨ìˆœ URL ë³€ê²½ â†’ í…œí”Œë¦¿ ìˆ˜ì •ìœ¼ë¡œ ì¶©ë¶„
- âŒ SMTPë§Œ ì‚¬ìš© â†’ Resend SMTPë¡œ ì¶©ë¶„

**êµí›ˆ:**
> ë³µì¡ë„ë¥¼ ë†’ì´ì§€ ë§ˆë¼. SMTP + í…œí”Œë¦¿ ìˆ˜ì •ì´ ê°€ì¥ ê°„ë‹¨í•˜ê³  ì•ˆì •ì ì´ë‹¤.

### 3. ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ ì¼ê´€ì„±

**ë¬¸ì œ ìƒí™©:**
```typescript
// ì½”ë“œì—ì„œëŠ” 'id' ì‚¬ìš©
.insert({ id: user.id })

// ì‹¤ì œ DBëŠ” 'user_id'
// âŒ Error: Could not find the 'id' column
```

**í•´ê²°:**
1. í”„ë¡œì íŠ¸ ì „ì²´ ì»¬ëŸ¼ëª… í†µì¼ (`user_id`ë¡œ ê²°ì •)
2. `database.types.ts` ìë™ ìƒì„± í™œìš©
3. API ì½”ë“œ ì‘ì„± ì „ ìŠ¤í‚¤ë§ˆ í™•ì¸

**í™•ì¸ ë°©ë²•:**
```typescript
// Pythonìœ¼ë¡œ ìŠ¤í‚¤ë§ˆ í™•ì¸
result = supabase.table('users').select('*').limit(1).execute()
columns = list(result.data[0].keys())
print(columns)  # ['user_id', 'email', 'nickname', ...]
```

### 4. auth.users â†” users í…Œì´ë¸” ë™ê¸°í™”

**íŠ¸ëœì­ì…˜ ë¬´ê²°ì„± ë³´ì¥:**

```typescript
// íšŒì›ê°€ì… API
const { data: authData } = await supabase.auth.signUp({...});

const { error: profileError } = await supabase
  .from('users')
  .insert({ user_id: authData.user.id, ... });

// âš ï¸ ì¤‘ìš”: ì‹¤íŒ¨ ì‹œ ë¡¤ë°±!
if (profileError) {
  await supabase.auth.admin.deleteUser(authData.user.id);
  return error;
}
```

```typescript
// ë¡œê·¸ì¸ API - ì´ì¤‘ ì•ˆì „ì¥ì¹˜
const { data: userProfile } = await supabase
  .from('users')
  .select('*')
  .eq('user_id', authData.user.id)
  .single();

// í”„ë¡œí•„ ì—†ìœ¼ë©´ ìë™ ìƒì„±
if (!userProfile) {
  await supabase.from('users').insert({...});
}
```

**êµí›ˆ:**
> auth.usersì™€ users í…Œì´ë¸”ì€ í•­ìƒ 1:1ë¡œ ë™ê¸°í™”ë˜ì–´ì•¼ í•œë‹¤.

### 5. ë””ë²„ê¹… í”„ë¡œì„¸ìŠ¤

**ì˜¬ë°”ë¥¸ ë””ë²„ê¹… ìˆœì„œ:**
1. ì¦ìƒ í™•ì¸ (ë¡œê·¸ì¸ ì‹¤íŒ¨, ì´ë©”ì¼ ë§í¬ ì—ëŸ¬ ë“±)
2. **ë°ì´í„° í™•ì¸** (auth.users vs users í…Œì´ë¸” ë¹„êµ)
3. **ìŠ¤í‚¤ë§ˆ í™•ì¸** (ì‹¤ì œ ì»¬ëŸ¼ëª… í™•ì¸)
4. ì½”ë“œ í™•ì¸ (APIì—ì„œ ì‚¬ìš©í•˜ëŠ” ì»¬ëŸ¼ëª… ê²€ì¦)
5. ìˆ˜ì • ë° ê²€ì¦

**ì•ˆí‹°íŒ¨í„´:**
- âŒ ì¦ìƒë§Œ ë³´ê³  ì„ì‹œ í•´ê²°ì±… ì ìš©
- âŒ ê·¼ë³¸ ì›ì¸ íŒŒì•… ì—†ì´ ë‹¤ë¥¸ ë°©ë²• ì‹œë„
- âŒ ë°ì´í„°/ìŠ¤í‚¤ë§ˆ í™•ì¸ ì—†ì´ ì½”ë“œë§Œ ìˆ˜ì •

**êµí›ˆ:**
> ë¬¸ì œ ë°œìƒ ì‹œ ë°ì´í„°ì™€ ìŠ¤í‚¤ë§ˆë¶€í„° í™•ì¸í•˜ë¼. ì½”ë“œëŠ” ê·¸ ë‹¤ìŒì´ë‹¤.

---

## ì²´í¬ë¦¬ìŠ¤íŠ¸

### Phase 1: Resend ì„¤ì •
- [ ] Resend ê³„ì • ìƒì„±
- [ ] ë„ë©”ì¸ ë“±ë¡
- [ ] DKIM TXT ë ˆì½”ë“œ ë“±ë¡ (Whois)
- [ ] DKIM ì¸ì¦ í™•ì¸ (Verified ìƒíƒœ)

### Phase 2: Supabase ì„¤ì •
- [ ] SMTP ì„¤ì • (Resend ì •ë³´ ì…ë ¥)
- [ ] Site URL ì„¤ì • (`https://www.yourdomain.com`)
- [ ] Redirect URLs ë“±ë¡ (`/auth/callback`)
- [ ] **ì´ë©”ì¼ í…œí”Œë¦¿ ìˆ˜ì •** (URL í•˜ë“œì½”ë”©) â­ ì¤‘ìš”!
- [ ] Send Email Hook ë¹„í™œì„±í™”

### Phase 3: Next.js API êµ¬í˜„
- [ ] íšŒì›ê°€ì… API ì‘ì„±
  - [ ] `emailRedirectTo` ì„¤ì •
  - [ ] users í…Œì´ë¸” ì‚½ì…
  - [ ] ì‹¤íŒ¨ ì‹œ ë¡¤ë°± ë¡œì§
- [ ] ì¸ì¦ ì½œë°± ì²˜ë¦¬ (`/auth/callback`)
- [ ] ë¡œê·¸ì¸ API ìˆ˜ì •
  - [ ] `user_id`ë¡œ ì¡°íšŒ
  - [ ] í”„ë¡œí•„ ì—†ìœ¼ë©´ ìë™ ìƒì„±

### Phase 4: ìŠ¤í‚¤ë§ˆ í™•ì¸
- [ ] users í…Œì´ë¸” ì»¬ëŸ¼ëª… í™•ì¸ (`user_id` vs `id`)
- [ ] ëª¨ë“  í…Œì´ë¸”ì—ì„œ `user_id` í†µì¼ í™•ì¸
- [ ] í•„ìˆ˜ ì»¬ëŸ¼ í™•ì¸ (nickname, is_active, terms_agreed ë“±)

### Phase 5: í…ŒìŠ¤íŠ¸
- [ ] íšŒì›ê°€ì… â†’ ì´ë©”ì¼ ë°œì†¡ í™•ì¸
- [ ] ì´ë©”ì¼ ë§í¬ í´ë¦­ â†’ ì¸ì¦ ì™„ë£Œ í™•ì¸
- [ ] ë¡œê·¸ì¸ ì„±ê³µ í™•ì¸
- [ ] users í…Œì´ë¸”ì— ë°ì´í„° ìƒì„± í™•ì¸

### Phase 6: í”„ë¡œë•ì…˜ ë°°í¬
- [ ] í™˜ê²½ë³€ìˆ˜ ì„¤ì • (Vercel)
- [ ] ë°°í¬ ë° í…ŒìŠ¤íŠ¸
- [ ] ì‹¤ì œ ì´ë©”ì¼ ì£¼ì†Œë¡œ í…ŒìŠ¤íŠ¸
- [ ] DKIM ì¸ì¦ í™•ì¸ (ìŠ¤íŒ¸ ë°©ì§€)

---

## ì°¸ê³  ìë£Œ

### Supabase ê³µì‹ ë¬¸ì„œ
- [Email Templates](https://supabase.com/docs/guides/auth/auth-email-templates)
- [Send Email Hook](https://supabase.com/docs/guides/auth/auth-hooks/send-email-hook)
- [SMTP Configuration](https://supabase.com/docs/guides/auth/auth-smtp)

### Resend ê³µì‹ ë¬¸ì„œ
- [DKIM Setup](https://resend.com/docs/dashboard/domains/introduction)
- [SMTP Integration](https://resend.com/docs/send-with-smtp)

### ì´ í”„ë¡œì íŠ¸ì˜ ê´€ë ¨ íŒŒì¼
- `1_Frontend/src/app/api/auth/signup/route.ts` - íšŒì›ê°€ì… API
- `1_Frontend/src/app/api/auth/login/route.ts` - ë¡œê·¸ì¸ API
- `1_Frontend/src/app/auth/callback/route.ts` - ì¸ì¦ ì½œë°±
- `0-5_Development_ProjectGrid/action/PROJECT_GRID_REVISED/grid/update_P3BA1_email_verification_complete.json` - ì „ì²´ ì‘ì—… ë¡œê·¸

---

## ë§ˆë¬´ë¦¬

ì´ ê°€ì´ë“œëŠ” ì•½ 10ì‹œê°„ì˜ ì‹œí–‰ì°©ì˜¤ ëì— ì–»ì€ ì‹¤ì „ ê²½í—˜ì…ë‹ˆë‹¤.

**í•µì‹¬ 3ê°€ì§€:**
1. **ì´ë©”ì¼ í…œí”Œë¦¿ì€ í•˜ë“œì½”ë”©í•˜ë¼** (`{{ .SiteURL }}` í•¨ì • ì¡°ì‹¬)
2. **auth.usersì™€ users í…Œì´ë¸”ì„ í•­ìƒ ë™ê¸°í™”í•˜ë¼** (ë¡¤ë°± ë¡œì§ í•„ìˆ˜)
3. **Send Email Hookì€ ë³µì¡ë„ë§Œ ë†’ì¸ë‹¤** (SMTP + í…œí”Œë¦¿ìœ¼ë¡œ ì¶©ë¶„)

ì—¬ëŸ¬ë¶„ì˜ í”„ë¡œì íŠ¸ì— ì´ ê°€ì´ë“œê°€ ë„ì›€ì´ ë˜ê¸¸ ë°”ëë‹ˆë‹¤!
